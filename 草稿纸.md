**1.**   **工程**

本案例使用的是C/S结构，项目分为ChatServer和ChatClient两个工程

-       **ChatServer****：实现了局域网通信服务器功能（服务端）**

-       **ChatClient****：实现了局域网通信客户端功能（客户端）**

本案例为纯Java项目，没有数据库支持，没有数据持久化要求

JDK：JDK17

开发工具：Eclipse

使用其他版本JDK或者开发工具，可能需要手动复制代码至工程中

先启动ChatServer，点击“启动服务”按钮

再启动ChatClient，进行连接

**2.**   **功能说明**

**（1）**   **登入系统**

用户在客户端登入界面填写一个任意的“用户名”登入系统，在“登入系统”时服务器会根据所有当前“在线用户”进行检测，保证用户名是唯一的。

**（2）**   **在线用户列表**

用户登入系统后，会看到所有“在线用户”的列表，”在线用户“列表每隔一段时间会自动刷新

**（3）**   **发送消息**

用户双击“在线用户“列表的某个用户名时，会打开与该在线用户的“聊天窗口”，在聊天窗口中可以发送文本消息给对方

**（4）**   **接收消息**

用户在“聊天窗口”与其他用户通信时，也可以接收到对方发来的消息，该消息会显示在聊天窗口的界面中。

如果其他用户发来消息时，“聊天窗口”没有打开，则需要“在线用户列表”中该用户的名字给出高亮显示

**（5）**   **退出系统**

用户关闭“登入界面”，“用户列表界面”界面时，会退出系统

用户关闭“聊天窗口”界面时，不会退出系统

**3.**   **任务**

**（1）**   **请求码（已完成）**

参考ChatServer和ChatClient工程com.neusoft.util.CodeDefine类中定义和注释

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg)

**（2）**   **客户端连接工具类（已完成）**

参考ChatClient工程com.neusoft.service.SocketService类中定义和注

**（3）**   **界面（已完成）**

客户端 - 登入界面（com.neusoft.view.SignInWindow）

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image004.jpg)

客户端 - 用户列表界面（com.neusoft.view.MainWindow）

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image006.jpg)

客户端 – 聊天窗口界面（com.neusoft.view.ChatWindow）

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image008.jpg)

服务器 – 控制台界面（com.neusoft.view.ServerListenerWindow）

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image010.jpg)

**（4）**   **登入请求（已完成：做为参考案例）**

客户端：

在com.neusoft.view.SignInWindow类的“进入系统”按钮的点击事件中实现登入功能。（大约在第72-99行）

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image012.jpg)

服务器：

在com.neusoft.service.UserThread类处理登录请求（大约在第56-71行）

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image014.jpg)

**（5）**   **刷新在线用户列表**

**客户端：**

在com.neusoft.view.MainWindow中**构造方法中**编写并启动一个**线程**，每隔10s中自动向服务器发送请求

**请求码：**CodeDefine.ONLINE_LIST

**请求格式：**请求码**,**    (请求码加一个英文逗号)

**服务器响应格式：**

用户名1,用户名2,……用户名n   （字符串类型，用户名间以英文逗号分隔）

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image016.jpg)

客户端需要将服务器响应的数据解析成字符串数组，然后刷新界面。

参考代码如下，其中rec为服务器响应的字符串

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image018.jpg)

**服务端：**

在com.neusoft.service.UserThread的run方法中设置相应的处理分支进行处理

在线用户的数据可以通过下方代码获取

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image020.jpg)

**（6）**   **发送消息**

**客户端：**

在com.neusoft.view.ChatWindow中“发送”按钮的单机事件中（大约81行）进行处理

**请求码：**CodeDefine.SEND_MESSAGE

**请求格式：**请求码,接收者用户名,发送的消息    (请求码加一个英文逗号)

**服务器响应格式：**OK   （客户端接收到响应后无需处理）

获得文本区域的内容，参考代码如下，其中inputArea为输入框

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image022.jpg)

设置文本区域的内容，参考代码如下，其中inputArea为输入框

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image024.jpg)

界面中有两个文本区域

-       **messageArea****：上方用于显示对话信息的只读文本区域**

-       **inputArea****：下方用于输入通信内容的文本区域**

**服务端：**

在com.neusoft.service.UserThread的run方法中设置相应的处理分支进行处理

在解析消息后需要将消息封装成Message对象，存入未读消息列表中，

参考代码如下，uname是发送者，message是消息内容，to_user是接收者

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image026.jpg)

**（7）**   **接收消息**

**客户端：**

在com.neusoft.view.MainWindow中**已经编写好了相关线程**，每隔4s中自动向服务器发送请求

**请求码：**CodeDefine.GET_MESSAGE

**请求格式：**请求码**,**    (请求码加一个英文逗号)

**服务器响应格式：消息1;消息2; …   (多个消息间以英文分号分隔)**

**单个消息格式：**来自用户,消息内容,发送时间  （单个消息内以英文逗号分隔）

客户端相应的解析程序已经编写完毕，只需要接收到正确格式服务端响应即可

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image028.jpg)

**服务端：**

在com.neusoft.service.UserThread的run方法中设置相应的处理分支进行处理

**com.neusoft.service.UserThread****类中的mlist属性即为所有未读的消息**

**（8）**   **退出系统**

**客户端：**

在com.neusoft.view.MainWindow中**initialize()**，中，为frame窗体对象设置了windowClosing事件，在客户端点击右上角关闭按钮时，通知服务器结束。否则服务器因为客户端单方失联而无法接收服务线程，造成不断的抛出异常。

**请求码：**CodeDefine.SIGN_OFF

**请求格式：**请求码**,**    (请求码加一个英文逗号)

**服务器响应格式：OK**

**代码编写位置：**

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image030.jpg)

**服务端：**

在com.neusoft.service.UserThread的run方法中设置相应的处理分支进行处理

**服务端在退出服务线程前，需要在“用户-线程”映射中注销用户，参考代码如下**

![](file:///C:/Users/HANATABA/AppData/Local/Temp/msohtmlclip1/01/clip_image032.jpg)

给出客户端响应后，通过break结束死循环，服务线程UserThread会自然结束，